---
name: s3
description: AWS S3 / MinIO integration - presigned URLs, upload/download, multipart
triggers:
  - s3
  - minio
  - presigned url
  - file upload
  - object storage
  - dosya y√ºkleme
---

# S3 / MinIO Integration

Patterns for AWS S3 and MinIO object storage with AWS SDK v3.

## 1. Client Setup (Dual Endpoint)

**CRITICAL: influos.app uses dual endpoints.**

```typescript
// lib/s3.ts
import { S3Client, PutObjectCommand, GetObjectCommand, DeleteObjectCommand } from '@aws-sdk/client-s3'
import { getSignedUrl } from '@aws-sdk/s3-request-presigner'

// Server-side client (internal Docker network)
const s3Internal = new S3Client({
  region: process.env.S3_REGION ?? 'us-east-1',
  endpoint: process.env.S3_INTERNAL_ENDPOINT, // http://minio:9000 (Docker)
  forcePathStyle: true,
  credentials: {
    accessKeyId: process.env.S3_ACCESS_KEY!,
    secretAccessKey: process.env.S3_SECRET_KEY!,
  },
})

// For presigned URLs (browser-accessible endpoint)
const s3Public = new S3Client({
  region: process.env.S3_REGION ?? 'us-east-1',
  endpoint: process.env.S3_PUBLIC_ENDPOINT, // https://s3.influos.app
  forcePathStyle: true,
  credentials: {
    accessKeyId: process.env.S3_ACCESS_KEY!,
    secretAccessKey: process.env.S3_SECRET_KEY!,
  },
})
```

## 2. Upload

```typescript
export async function uploadFile({
  bucket,
  key,
  body,
  contentType,
}: {
  bucket: string
  key: string
  body: Buffer | Uint8Array | ReadableStream
  contentType: string
}) {
  await s3Internal.send(
    new PutObjectCommand({
      Bucket: bucket,
      Key: key,
      Body: body,
      ContentType: contentType,
    })
  )
  return { key, bucket }
}
```

## 3. Presigned URL (Download)

```typescript
export async function getPresignedDownloadUrl({
  bucket,
  key,
  expiresIn = 3600,
}: {
  bucket: string
  key: string
  expiresIn?: number
}) {
  // Use PUBLIC client for browser-accessible URLs
  const url = await getSignedUrl(
    s3Public,
    new GetObjectCommand({ Bucket: bucket, Key: key }),
    { expiresIn }
  )
  return url
}
```

## 4. Presigned URL (Upload)

```typescript
export async function getPresignedUploadUrl({
  bucket,
  key,
  contentType,
  expiresIn = 600,
}: {
  bucket: string
  key: string
  contentType: string
  expiresIn?: number
}) {
  // Use PUBLIC client for browser-accessible URLs
  const url = await getSignedUrl(
    s3Public,
    new PutObjectCommand({
      Bucket: bucket,
      Key: key,
      ContentType: contentType,
    }),
    { expiresIn }
  )
  return url
}
```

## 5. Multipart Upload (Large Files)

```typescript
import { CreateMultipartUploadCommand, UploadPartCommand, CompleteMultipartUploadCommand } from '@aws-sdk/client-s3'

const PART_SIZE = 10 * 1024 * 1024 // 10MB

export async function multipartUpload({
  bucket,
  key,
  buffer,
  contentType,
}: {
  bucket: string
  key: string
  buffer: Buffer
  contentType: string
}) {
  const { UploadId } = await s3Internal.send(
    new CreateMultipartUploadCommand({
      Bucket: bucket,
      Key: key,
      ContentType: contentType,
    })
  )

  const parts: { ETag: string; PartNumber: number }[] = []
  const partCount = Math.ceil(buffer.length / PART_SIZE)

  for (let i = 0; i < partCount; i++) {
    const start = i * PART_SIZE
    const end = Math.min(start + PART_SIZE, buffer.length)

    const { ETag } = await s3Internal.send(
      new UploadPartCommand({
        Bucket: bucket,
        Key: key,
        UploadId,
        PartNumber: i + 1,
        Body: buffer.subarray(start, end),
      })
    )

    parts.push({ ETag: ETag!, PartNumber: i + 1 })
  }

  await s3Internal.send(
    new CompleteMultipartUploadCommand({
      Bucket: bucket,
      Key: key,
      UploadId,
      MultipartUpload: { Parts: parts },
    })
  )

  return { key, bucket, parts: partCount }
}
```

## 6. Delete

```typescript
export async function deleteFile({ bucket, key }: { bucket: string; key: string }) {
  await s3Internal.send(
    new DeleteObjectCommand({ Bucket: bucket, Key: key })
  )
}
```

## Dependencies

```bash
npm install @aws-sdk/client-s3 @aws-sdk/s3-request-presigner
```

## Gotchas

| Issue | Solution |
|-------|----------|
| Presigned URL returns Docker hostname | Use PUBLIC s3 client for presigned URLs |
| CORS errors on upload | Configure MinIO/S3 CORS policy |
| `forcePathStyle` required for MinIO | Always set `forcePathStyle: true` |
| Large file upload timeout | Use multipart upload for files > 10MB |

## Environment Variables

```
S3_INTERNAL_ENDPOINT=http://minio:9000
S3_PUBLIC_ENDPOINT=https://s3.example.com
S3_ACCESS_KEY=xxx
S3_SECRET_KEY=xxx
S3_REGION=us-east-1
S3_BUCKET=default
```
